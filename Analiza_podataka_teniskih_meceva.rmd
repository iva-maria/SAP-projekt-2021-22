---
title: "**Analiza podataka teniskih mečeva**"
author: Antonio Babić, Iva Maria Ivanković, Gabrijel Jambrošić, Antun Jurelinac
date: 14. siječanj 2022.
output: 
  pdf_document: 
    number_sections: yes
    toc: yes
toc-title: "Sadržaj"
toc-depth: 3
---

```{r setup, include = FALSE}
library(gridExtra)
fig.width = 5
```

\newpage

# Motivacija i opis problema

Statistička analiza podataka oduvijek je prisutna u sportu. Njome se služe komentatori koji prije neke važne utakmice trebaju naučiti što više činjenica o igraču ili timu, što spada pod deskriptivnu statistiku. Investitori na temelju statistike kluba raspoređuju svoja ulaganja, što za posljedicu može imati napredak kluba ili njegovu potpunu propast. Plaće igrača i njihove cijene na tržištu transfera izravno ovise o njihovoj statistici u prethodnoj sezoni, a kladionice provode iscrpne analize podataka kako bi postavile kvote.

U tenisu je statistika kao alat dobila dodatnu popularnost zahvaljujući bivšem treneru Craigu O'Shaughnessyju, strategu s uporištem u statistici čija je analiza bila ključna u rezultatima Novaka Đokovića protiv njegovih najvećih rivala. Svojim zaključcima izvedenim iz povijesnih podataka mečeva tenisačima je moguće prilagoditi kondicijske pripreme, teniske treninge i strategiju protiv pojedinih protivnika, što rezultira boljom i konzistentnijom igrom.

U nastavku teksta analizirat će se skup podataka o teniskim mečevima i tenisačima te će se iz podataka pokušati izvesti zaključci i pomoću njih odgovoriti na projektna pitanja. Analiza podataka bit će provedena u programskom jeziku *R*, a odabrano okruženje je *RStudio*.

# Opis i učitavanje skupa podataka

## Opis skupa podataka

Podaci se sastoje od svih ATP mečeva odigranih između 1991. i 2020. godine. Svakom igraču pridodano je više značajki kao što su visina, starost, ruka kojom igra, igra li jednoručni ili dvoručni backhand itd. Dodatno je svaki meč opisan s više značajki poput rankinga pobjednika, rankinga gubitnika, trajanja meča, broja winnera pobjednika, broja neprisiljenih grešaka gubitnika, broja spašenih break prilika i sl.

Jedan redak u tablici skupa podataka sadrži podatke raspoređene u sljedeće stupce (ne moraju sve vrijednosti biti definirane): redni broj podatka, identifikacijska oznaka turnira, naziv turnira, vrsta podloge, broj natjecatelja na turniru, razina turnira, datum održavanja turnira, redni broj meča, rezultat meča, broj setova (*best of x*), razina meča (npr. kvalifikacijski, četvrtfinale, finale) i trajanje meča. Informacije o pobjedniku i gubitniku sadržane su u sljedećim stupcima, za svakog od dvojice igrača zasebno: identifikacijska oznaka, jakosna skupina u ždrijebu, \textcolor{red}{entry}, ime i prezime, dominantna ruka, visina, nacionalnost, dob, \textcolor{red}{ace}, \textcolor{red}{df}, \textcolor{red}{svpt}, \textcolor{red}{1stIn}, \textcolor{red}{1stWon}, \textcolor{red}{2ndWon}, \textcolor{red}{svGms}, \textcolor{red}{bpSaved}, \textcolor{red}{bpFaced}, ranking te ranking bodovi.


## Učitavanje skupa podataka

Zadani skup podataka učitan je iz .csv datoteke *tennis_atp_matches.csv*.

```{r}
tennis <- read.csv("tennis_atp_matches.csv")
```

Odmah na početku jasno je da su neki od podataka suvišni za analizu koja će biti provedena u sklopu projekta pa će odmah na početku odgovarajući stupci biti eliminirani iz tablice radi bolje preglednosti podataka. To su podaci poput naziva i datuma održavanja turnira te rednog broja meča. \textcolor{red}{Ovdje ćemo kasnije dodati sve stupce koje nismo koristili uz objašnjenje da se tih stupaca naša pitanja ne tiču. Slobodno izbacite neke stupce koji vam ipak trebaju. Zakomentirala sam jer mi inače javlja error koji nisam još skužila zašto se pojavljuje.}

```{r}
#tennis <- subset(tennis, select = -c(tourney_name, tourney_date, match_num))
```

\textcolor{red}{Možda ovdje dodati neki summary podataka ako budemo imali vremena i volje.}

# Projektna pitanja

U sklopu zadatka postavljena su četiri pitanja, uz mogućnost postavljanja vlastitih pitanja i pokretanja dodatne problematike vezano za dani skup podataka. \textcolor{red}{U slučaju da ipak nećemo postavljati vlastita pitanja, ovaj dio teksta trebalo bi malo izmijeniti.}

## Zadana pitanja

### Distribucija visine igrača

Postavljeno pitanje bilo je: Možemo li nešto zaključiti iz distribucije visine najboljih deset igrača u posljednjih 30 godina u odnosu na distribuciju visine igrača koji nisu bili tako uspješni?

Kako je u skupu podataka svakom igraču pridružen njegov ranking, taj će se podatak koristiti pri određivanju najuspješnijih igrača. Svake godine igrač dobije novi ranking te se za svaku godinu može odrediti popis deset igrača s najboljim rankingom. Nakon što se prikupe podaci svih trideset godina, profiltriraju se na način da se svaki igrač pojavljuje samo jednom.To je skup podataka koji će se koristiti u analizi i predstavljati najuspješnije igrače. \textcolor{red}{Malo nespretan način izdvajanja odmah na početku. Što ako je visina NA i pretvori se u 1000? Nije se dogodilo, ali treba pripazti na općeniti slučaj.}

S obzirom na činjenicu da se u skupu podataka na nekim mjestima pojavljuju igrači kojima nije definiran ranking, postavit ćemo im ranking na 1000 kako ne bi ušli u selekciju igrača s najboljim rankingom. Broj 1000 odabran je donekle proizvoljno - mogao je biti i 11, bitno je da je veći od 10.

```{r}
rankingRelevantData <- tennis[c("winner_id", "winner_name", "winner_rank", "winner_ht")]
rankingRelevantData[is.na(rankingRelevantData)] = 1000
```

Iz podataka se zatim izvuče popis svih pobjednika mečeva za koje je u bilo kojem meču zabilježen ranking <= 10. Razlog zašto se gledaju samo pobjednici jasan je ako se malo promisli o samom sustavu rangiranja - niti jedan igrač koji je u nekom trenutku bio među najboljom desetoricom nije se mogao ne pojaviti u barem jednom meču kao pobjednik.

```{r}
#svi igrači koji su u nekom trenutku imali ranking <= 10
winnersBestRanking <- rankingRelevantData[rankingRelevantData$winner_rank <= 10,]

#izdvajanje relevantnih stupaca
bestRanking <- winnersBestRanking[c("winner_id", "winner_name", "winner_ht")]

#brisanje duplikata
mostSuccessfulPlayers <- unique(bestRanking)
colnames(mostSuccessfulPlayers) <- c("player_id", "player_name", "player_ht")
```

Skup igrača koji nisu bili tako uspješni ustvari je skup svih ostalih igrača.

Taj popis dobijemo tako što iz tablice s popisom svih igrača izuzmemo one retke koji se nalaze u tablici s popisom najuspješnijih igrača.

```{r}
#popis svih igrača koji imaju barem jednu zabilježenu pobjedu
winners <- tennis[c("winner_id", "winner_name", "winner_ht")]
groupedWinners <- subset(as.data.frame(table(winners)), Freq != 0)
groupedWinners[4] = NULL
colnames(groupedWinners) <- c("player_id", "player_name", "player_ht")

#popis svih igrača koji imaju barem jedan zabilježen gubitak
losers <- tennis[c("loser_id", "loser_name", "loser_ht")]
groupedLosers <- subset(as.data.frame(table(losers)), Freq != 0)
groupedLosers[4] = NULL
colnames(groupedLosers) <- c("player_id", "player_name", "player_ht")

#full outer join pobjednika i gubitnika
allPlayers <- merge(groupedWinners, groupedLosers, all = TRUE)

#izuzimamo igrače koji su među najuspješnijima
notSoSuccessfulPlayers <- subset(allPlayers, !player_id %in% mostSuccessfulPlayers$player_id)
```

Nakon što smo izdvojili najuspješnije i one manje uspješne igrače u skupove podataka ```mostSuccesfulPlayers``` i ```notSoSuccessfulPlayers```, možemo početi s analizom podataka. Za početak, ispisujemo neke osnovne informacije o jednim i drugim igračima kako bi čitatelj dobio sliku. Najvažnije mjere centralne tendencije jesu aritmetička sredina, medijan i mod: \textcolor{red}{Dodati mod.}

```{r}
summary(mostSuccessfulPlayers$player_ht)

notSoSuccessfulPlayers$player_ht <- as.numeric(as.character(notSoSuccessfulPlayers$player_ht))
summary(notSoSuccessfulPlayers$player_ht)
```

Računamo neke osnovne mjere rasipanja podataka - rang, interkvartilni rang, varijancu i standardnu devijaciju - te na taj način uviđamo koliko su visine pojedine skupine igrača međusobno različite. \textcolor{red}{Računa li var() nepristranu varijancu?}

```{r}

```

Vizualiziramo podatke, prvo za najuspješnije igrače, zatim za one manje uspješne.

```{r}
boxplot(mostSuccessfulPlayers$player_ht, notSoSuccessfulPlayers$player_ht, 
        names = c('Most succesful players\' heights','Less succesful players\' heights'),
        main='Boxplot of most and least successful players\' heights')
```

```{r}
h_mostSuccesfulPlayers = hist(mostSuccessfulPlayers$player_ht,
                              main = "Visine najuspješnijih igrača",
                              xlab = "Visina igrača [cm]",
                              ylab = "Frekvencija",
                              breaks = 5,
                              col = "palegreen")
```

```{r}
h_notSoSuccesfulPlayers = hist(notSoSuccessfulPlayers$player_ht,
                               main = "Visine manje uspješnih igrača",
                               xlab = "Visina igrača [cm]",
                               ylab = "Frekvencija",
                               breaks = 5,
                               col = "palevioletred")
```

Ovaj je prikaz dosta grub, ali iz njega i dalje možemo izvući neke zaključke. Naime, usporedbom \textit{boxplota} uviđamo da je srednja vrijednost visine nešto viša za najuspješnije igrače. Usporedbom histograma uviđamo da, iako je visina većine igrača i jedne i druge skupine između 180 i 190 cm, kod onih manje uspješnih igrača broj onih čija je visina manja od 180 cm znatno je veći od onih čija je visina veća od 190 cm, dok to kod najuspješnijih igrača nije slučaj.

Histogram vrijednosti visina najuspješnijih igrača ima zvonolik oblik, a pretpostavka je da bi i histogram vrijednosti visina manje uspješnih igrača imao sličan oblik ako se broj razreda poveća. Da bismo se u to uvjerili, možemo podatke prikazati histogramom s većim brojem razreda:

```{r}
h2_mostSuccesfulPlayers = hist(mostSuccessfulPlayers$player_ht,
                              main = "Visine najuspješnijih igrača",
                              xlab = "Visina igrača [cm]",
                              ylab = "Frekvencija",
                              breaks = 10,
                              col = "palegreen")
```

```{r}
h_notSoSuccesfulPlayers = hist(notSoSuccessfulPlayers$player_ht,
                               main = "Visine manje uspješnih igrača",
                               xlab = "Visina igrača [cm]",
                               ylab = "Frekvencija",
                               breaks = 10,
                               col = "palevioletred")
```

Oblik histograma upućuje na to da se podaci ravnaju po normalnoj razdiobi. Da bismo to sa sigurnošću mogli tvrditi, potrebno je provesti test normalnosti varijabli. 

```{r}
qqnorm(mostSuccessfulPlayers$player_ht, pch = 20, frame = FALSE, main='Most succesful players')
qqline(mostSuccessfulPlayers$player_ht, col = "blue", lwd = 2)

qqnorm(notSoSuccessfulPlayers$player_ht, pch = 20, frame = FALSE, main='Less succesful players')
qqline(notSoSuccessfulPlayers$player_ht, col = "blue", lwd = 2)
```
Čini se da podaci prate ravnu liniju pa možemo pretpostaviti da je razdioba normalna.

Pod tom pretpostavkom prvo ćemo se pozabaviti jednakošću varijanci, odnosno dokazivanjem iste, a zatim ćemo provesti testove i postaviti hipoteze o jednakosti prosječnih vrijednosti visina uspješnih i onih manje uspješnih igrača.



Hipoteze testa jednakosti varijanci glase:
$$ \begin{aligned}
H_0&: \sigma_1^2 = \sigma_2^2 \\
H_1&: \sigma_1^2 < \sigma_2^2 \quad \text{,} \quad \sigma_1^2 > \sigma_2^2 \quad \text{,} \quad \sigma_1^2 \neq \sigma_2^2
\end{aligned} $$

Ispitujemo jednakost varijanci prikupljenih uzoraka:

```{r}
var.test(mostSuccessfulPlayers$player_ht, notSoSuccessfulPlayers$player_ht)
```
p-vrijednost od 0.04659 govori nam da ne možemo odbaciti hipotezu o jednakosti varijanci, tj. da varijance možemo smatrati jednakima.

\textcolor{red}{Provesti test da dokažemo da visine prate normalnu razdiobu, zatim provesti test da s nekom sigurnošću odredimo aritmetičke sredine visina za najuspješnije i one manje uspješne igrače. Naposlijetku provesti test hipoteze da dvije skupine igrača imaju jednaku srednju visinu.}

### Odnos ljevaka i dešnjaka



### Pobjeda prvog seta



### Predviđanje pobjednika meča



## Vlastita pitanja

***

1) Mozemo li nesto zakljuciti iz distribucije visine najboljih deset igraca u posljednjih 30 godina u odnosu
na distribuciju visine igraca koji nisu bili tako uspjesni?

Kreiramo novu tablicu u koju rangiramo igrace po broju pobjeda, za pocetak. Raspravljali smo o tome da ih rangiramo po postotku pobjeda, ali to nema smisla zbog toga sto netko npr. moze imati 2/2 pobjede, a netko 19/20. (Postaviti pitanje asistentu.)

```{r}
pobjednici <- tennis[c("winner_id", "winner_name", "winner_ht")]
grupiraniPobjednici <- subset(as.data.frame(table(pobjednici)), Freq != 0)
colnames(grupiraniPobjednici) <- c("player_id", "player_name", "player_ht", "no_of_wins")
sortiraniPobjednici <- grupiraniPobjednici[order(grupiraniPobjednici$no_of_wins, decreasing = TRUE),]
desetNajboljih <- head(sortiraniPobjednici, 10)
```

Problem se pojavio kod traženja igrača koji nisu bili tako uspješni. Naime, nema smisla rangirati ih po najmanjem broju pobjeda, jer će biti puno igrača s 0 ili 1 pobjedom. Isto tako, rangiranje po najmanjem postotku pobjeda ne bi bilo baš sretno rješenje. Iz tog razloga, rangiramo ih po najvećem broju gubitaka i nadamo se da će podaci imati smisla.

Time smo dobili tablicu u kojoj se pojavljuje Andy Murray, što nikako nema smisla. Ovaj kod ispod ne treba gledati!

```{r}
gubitnici <- tennis[c("loser_id", "loser_name", "loser_ht")]
grupiraniGubitnici <- subset(as.data.frame(table(gubitnici)), Freq != 0)
colnames(grupiraniGubitnici) <- c("player_id", "player_name", "player_ht", "no_of_losses")
sortiraniGubitnici <- grupiraniGubitnici[order(grupiraniGubitnici$no_of_losses, decreasing = TRUE),]
desetNajlosijih <- head(sortiraniGubitnici, 10)
```

Sljedeće rješenje, koje smatramo najboljim, jest da 'odsiječemo' igrače s najmanjim brojem mečeva i onda za ostale gledamo najmanji postotak pobjeda.

```{r}
#full outer join pobjednika i gubitnika
pobjedeIPorazi <- merge(grupiraniPobjednici, grupiraniGubitnici, all = TRUE)

#mijenja NA s 0 gdje god se pojavljuje da se moze zbrajati
pobjedeIPorazi[is.na(pobjedeIPorazi)] = 0

#dodajemo novi stupac u kojem pise ukupan broj odigranih meceva
for (i in 1:nrow(pobjedeIPorazi)) {
   pobjedeIPorazi$total[i] <- pobjedeIPorazi$no_of_wins[i] + pobjedeIPorazi$no_of_losses[i]
}

#sortiramo tenisace po ukupnom broju meceva
pobjedeIPoraziSortirano <- pobjedeIPorazi[order(pobjedeIPorazi$total, decreasing = TRUE),]

#uzimamo samo one koji imaju vise od 100 meceva
pobjedeIPoraziSortiranoBezNajlosijih <- subset(pobjedeIPoraziSortirano, pobjedeIPoraziSortirano$total >= 100)

#dodajemo novi stupac u kojem pise postotak pobjeda u ukupnom broju meceva
for(i in 1:nrow(pobjedeIPoraziSortiranoBezNajlosijih)) {
  pobjedeIPoraziSortiranoBezNajlosijih$win_percentage[i] <- pobjedeIPoraziSortiranoBezNajlosijih$no_of_wins[i] / pobjedeIPoraziSortiranoBezNajlosijih$total[i]
}

#sortiramo tenisace po postotku pobjeda
pobjedeIPoraziSortiranoBezNajlosijihSortiranoPoPostotku <- pobjedeIPoraziSortiranoBezNajlosijih[order(pobjedeIPoraziSortiranoBezNajlosijih$win_percentage, decreasing = TRUE),]

#uzmemo one koji imaju <33% pobjede
najlosiji <- subset(pobjedeIPoraziSortiranoBezNajlosijihSortiranoPoPostotku, pobjedeIPoraziSortiranoBezNajlosijihSortiranoPoPostotku$win_percentage <= 0.34)
desetNajlosijih <- tail(najlosiji, 10)
```

Potrebno je sada spojiti igrače s njihovom visinom i odrediti distribuciju tih podataka.

```{r}
prosjecnaVisinaNajboljih <- mean(as.numeric(as.character(desetNajboljih$player_ht)))
varijancaVisineNajboljih <- var(as.numeric(as.character(desetNajboljih$player_ht)))
standardnaDevijacijaVisineNajboljih <- sd(as.numeric(as.character(desetNajboljih$player_ht)))
```

```{r}
prosjecnaVisinaNajlosijih <- mean(as.numeric(as.character(desetNajlosijih$player_ht)))
varijancaVisineNajlosijih <- var(as.numeric(as.character(desetNajlosijih$player_ht)))
standardnaDevijacijaVisineNajlosijih <- sd(as.numeric(as.character(desetNajlosijih$player_ht)))
```

Izrađujemo dijagram raspršenja za visinu igrača i postotak pobjeda. Iz nekog razloga, pojavljuju se mali box plotovi unutar scatter plota (pitati asistenta zašto bi to moglo biti).

```{r}
#x <- pobjedeIPoraziSortiranoBezNajlosijih$player_ht
#y <- pobjedeIPoraziSortiranoBezNajlosijih$win_percentage
#plot(x, y, xlab = 'Visina igrača [cm]', ylab = 'Postotak pobjeda')
```

```{r}
pobjednici = tennis[c("winner_id", "winner_name")]
grupiraniPobjednici = subset(as.data.frame(table(pobjednici)), Freq != 0)
sortiraniPobjednici = grupiraniPobjednici[order(grupiraniPobjednici$Freq, decreasing = TRUE),]
desetNajboljih = head(sortiraniPobjednici, 10)
```

```{r}
library(rvest)
stranica <- read_html("http://www.tennisdrawchallenge.com/data/list/one-handed-backhand")
tables <- stranica %>% html_table(fill = TRUE)
jedno_back <- tables[[1]]
igraci_1HBH <- jedno_back["Name"]
lista_1HBH = igraci_1HBH[["Name"]]
```
```{r}
jedno_back_mecevi_protiv_L = subset(tennis, ((as.character(winner_name) %in% lista_1HBH & !(as.character(loser_name) %in% lista_1HBH) & as.character(winner_hand)=="R" & as.character(loser_hand)=="L") | (as.character(loser_name) %in% lista_1HBH & as.character(loser_hand)=="R" & as.character(winner_hand)=="L" & !(as.character(winner_name) %in% lista_1HBH) )))
jedno_back_mecevi_protiv_R = subset(tennis, ((as.character(winner_name) %in% lista_1HBH & as.character(winner_hand)=="R" & as.character(loser_hand)=="R") | (as.character(loser_name) %in% lista_1HBH & as.character(loser_hand)=="R" & as.character(winner_hand)=="R")))
rezultati_L <- data.frame(value = numeric())
rezultati_R <-data.frame(value = numeric())
n1=0
n2=0
for (i in 1:nrow(jedno_back_mecevi_protiv_L)){
  if (as.character(jedno_back_mecevi_protiv_L[i,"winner_name"] %in% lista_1HBH)){
    rezultati_L[i,"value"] <- 1
    n1=n1+1
  } else {
    rezultati_L[i,"value"] <- 0
  }
}
for (i in 1:nrow(jedno_back_mecevi_protiv_R)){
  if (as.character(jedno_back_mecevi_protiv_R[i,"winner_name"] %in% lista_1HBH)){
    rezultati_R[i,"value"] <- 1
    n2=n2+1
  } else {
    rezultati_R[i,"value"] <- 0
  }
}
```


```{r}
z_vrijednost = (mean(rezultati_L$value)- mean(rezultati_R$value))/sqrt(((n1+n2)/(nrow(rezultati_L)+nrow(rezultati_R)))*(1-(n1+n2)/(nrow(rezultati_L)+nrow(rezultati_R)))*(1/n1+1/n2))
pnorm(z_vrijednost)
mean(rezultati_L$value)
mean(rezultati_R$value)
#t.test(rezultati_L$value, rezultati_R$value, alt="greater")
```


```{r}
ruke = tennis[c("winner_hand", "loser_hand")]
razl_ruke = subset(ruke,(as.character(winner_hand)!=as.character(loser_hand) & as.character(loser_hand)!= "U" & as.character(winner_hand)!= "U" & as.character(loser_hand)!= "" & as.character(winner_hand)!= ""))
grupiraneruke = subset(as.data.frame(table(razl_ruke)), Freq != 0)
```

Možemo li na temelju dobitnika prvog seta predvidjeti dobitnika cijelog meča?

Moje pitanje:
Možemo li reći da je dobitnik prvog seta bolji igrač?

Zadajemo hipotezu H0 koja glasi: Igrači su jednako dobri (odnosno imaju jednaku vjerojatnost dobitka pojedinog seta). Ovdje pretpostavljamo da svi igrači jednako igraju u svim setovima iako će se neki igrači npr. brže umoriti.
Sada je alternativna hipoteza H1: Igrač koji je dobio prvi set je bolji igrač.

Vjerojatnost da dobitnik prvog seta pobijedi uz uvjet da je H0 istinita je 0,5 + 0,5^2 = 0,75.
To znači da od n mečeva očekujemo da će dobitnik prvog seta pobijediti u njih 0,75*n.
Broj takvih mečeva je varijabla podvrgnuta binomnoj razdiobi s parametrima n i p=0,75.
Budući da mi imamo puno podataka, možemo binomnu razdiobu aproksimirati normalnom s parametrima np i npq.

Sada možemo hipoteze postaviti na sljedeći način:
H0 - Vjerojatnost pobjede prvog igrača je 0,75.
H1 - Vjerojatnost pobjede prvog igrača je veća od 0,75.

```{r}
full_sets <- tennis[!grepl("[A-Za-z]", tennis$score),]
to_kaj_ocu = gregexpr(pattern = '-', full_sets$score)
i = 1
first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on = full_sets[FALSE,]
for(to in to_kaj_ocu) {
  if((length(to) == 2 || (length(to) == 3 &&
        ((substr(full_sets[i,]$score, to[1] - 1, to[1] - 1) < substr(full_sets[i,]$score, to[1] + 1, to[1] + 1))
      || (substr(full_sets[i,]$score, to[2] - 1, to[2] - 1) < substr(full_sets[i,]$score, to[2] + 1, to[2] + 1))))) == TRUE) {
    first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on[
      nrow(first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on) + 1,
    ] = full_sets[i,]
  }
  i = i + 1
  if(i %% 10000 == 0) print(i)
}
```

```{r}
sum(substr(first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on$score, 1, 1) > substr(first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on$score, 3, 3)) / nrow(first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on)
n = nrow(first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on)
p = 0.75
o = sum(substr(first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on$score, 1, 1) > substr(first_to_2_sets_wins_I_mean_why_are_there_even_other_types_of_matches_just_to_annoy_poor_students_working_on_their_projects_I_mean_come_on$score, 3, 3))
pnorm(o, mean = n * p, sd = sqrt(n * p * (1 - p)), lower.tail = FALSE)
```

```{r}
unfinished_sets <- tennis[grepl("[A-Za-z]", tennis$score),]
unfinished_ages <- round(unfinished_sets[c("loser_age")])
grupirani_unf <- subset(as.data.frame(table(unfinished_ages)), Freq != 0)
plot(grupirani_unf)
```

Ovisnost razlike u ratingu i trajanja meča
```{r}
known_ranks = na.omit(full_sets[,c("minutes", "winner_rank", "loser_rank")])
known_ranks = known_ranks[known_ranks$minutes < 500,]
known_ranks$rank_dif = abs(known_ranks$winner_rank - known_ranks$loser_rank)
fit.ranks = lm(minutes~rank_dif, data = known_ranks)
plot(known_ranks$rank_dif, known_ranks$minutes)
lines(known_ranks$rank_dif, fit.ranks$fitted.values, col = 'red')
```
Tu bi mogli uzet isti test, al samo najduljih 25% meceva...

Promatranje napretka najboljih igrača

```{r}
tri_najbolja <- sort(table(tennis$winner_id), decreasing=TRUE)[1:3]
godine <- sort(unique(substr(tennis$tourney_date, 1, 4)))
for(player_id in dimnames(tri_najbolja)[[1]]) {
  pobjede_po_godinama <- rep()
  for(godina in godine) {
    pobjede_po_godinama <- append(pobjede_po_godinama, nrow(tennis[which(tennis$winner_id == player_id & substr(tennis$tourney_date, 1, 4) == godina),])
    / nrow(tennis[which((tennis$winner_id == player_id | tennis$loser_id == player_id) & substr(tennis$tourney_date, 1, 4) == godina),]))
  }
  plot(godine, pobjede_po_godinama, type="b")
}
```


Je li odustajanje od meča nezavisno od vrste podloge na kojoj se on igra?

H0: Podloga teniskog terena i odustajanje od meča su nezavisni.
H1: Podloga teniskog terena i odustajanje od meča su zavisni.
```{r}
podloge <- subset(tennis, as.character(surface)!="")
podloge <- droplevels(podloge)
podloge$score <- ifelse(grepl("RET", podloge$score), "Retired", "Not retired")
```

Pogledajmo kontingencijsku tablicu varijabli podloge i odustajanja od meča
```{r}
tbl = table(podloge$surface, podloge$score)
tbl
```

Kontingencijskoj tablici dodajemo sume redaka i stupaca:
```{r}
added_margins_tbl = addmargins(tbl)
print(added_margins_tbl)
```

# promijenit malo tekst jer je prepisan
Test nezavisnosti $\chi^2$ test u programskom paketu R implementiran je u funkciji `chisq.test()` koja kao ulaz prima kontingencijsku tablicu podataka koje testiramo na nezavisnost. Ispitat ćemo nezavisnost podloge teniskog terena i odustajanja od meča.

Pretpostavka testa je da očekivana frekvencija pojedinog razreda mora biti veća ili jednaka 5 (`chisq.test()` pretpostavlja da je ovaj uvjet zadovoljen stoga je prije provođenja testa potrebno to provjeriti).
```{r}
for (col_names in colnames(added_margins_tbl)){
  for (row_names in rownames(added_margins_tbl)){
    if (!(row_names == 'Sum' | col_names == 'Sum') ){
      cat('Očekivane frekvencije za razred ',col_names,'-',row_names,': ',(added_margins_tbl[row_names,'Sum'] * added_margins_tbl['Sum',col_names]) / added_margins_tbl['Sum','Sum'],'\n')
    }
  }
}
```


Očekivane frekvencije su veće od 5 što znači da možemo nastaviti sa $\chi^2$ testom.
```{r}
chisq.test(tbl,correct=F)
```
Odbacujemo H0 u korist H1 koja kaže da su podloga teniskog terena i odustajanje od meča zavisni.